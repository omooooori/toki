#!/bin/bash

# ========================================
# Toki чТ░хвГшинхоЪуВ╗уГГуГИуВвуГГуГЧуВ╣уВпуГкуГЧуГИ
# ========================================

set -e

# шЙ▓ф╗ШуБНуБохЗ║хКЫщЦвцХ░
print_success() { echo -e "\033[32mтЬЕ $1\033[0m"; }
print_warning() { echo -e "\033[33mтЪая╕П  $1\033[0m"; }
print_error() { echo -e "\033[31mтЭМ $1\033[0m"; }
print_info() { echo -e "\033[34mЁЯУЭ $1\033[0m"; }
print_header() { echo -e "\033[35mЁЯЪА $1\033[0m"; }

print_header "Toki чТ░хвГшинхоЪуВ╗уГГуГИуВвуГГуГЧуВТщЦЛхзЛуБЧуБ╛уБЩ..."

# уГЧуГнуВ╕уВзуВпуГИуГлуГ╝уГИуБлчз╗хЛХ
cd "$(dirname "$0")/.."

# чТ░хвГшинхоЪуГХуВбуВдуГлуБохнШхЬичв║шкН
if [ ! -f ".env.example" ]; then
    print_error ".env.example уГХуВбуВдуГлуБМшжЛуБдуБЛуВКуБ╛уБЫуВУ"
    exit 1
fi

# уГЧуГнуВ╕уВзуВпуГИуГлуГ╝уГИуБо.envуГХуВбуВдуГлуБочв║шкН
if [ ! -f ".env" ]; then
    print_warning ".env уГХуВбуВдуГлуБМшжЛуБдуБЛуВКуБ╛уБЫуВУ"
    print_info "env.example уВТ .env уБлуВ│уГФуГ╝уБЧуБжуАБхоЯщЪЫуБохАдуВТшинхоЪуБЧуБжуБПуБауБХуБД"
    cp env.example .env
    print_success ".env уГХуВбуВдуГлуВТф╜ЬцИРуБЧуБ╛уБЧуБЯ"
    print_info "цмбуБлуАБ.env уГХуВбуВдуГлуВТч╖ищЫЖуБЧуБжхоЯщЪЫуБохАдуВТшинхоЪуБЧуБжуБЛуВЙуАБуБУуБоуВ╣уВпуГкуГЧуГИуВТхЖНхоЯшбМуБЧуБжуБПуБауБХуБД"
    exit 0
fi

# чТ░хвГхдЙцХ░уВТшкнуБ┐ш╛╝уБ┐
print_info "уГЧуГнуВ╕уВзуВпуГИуГлуГ╝уГИуБо .env уГХуВбуВдуГлуБЛуВЙчТ░хвГхдЙцХ░уВТшкнуБ┐ш╛╝уБ┐ф╕н..."
source .env

# уГРуГГуВпуВиуГ│уГЙчФиуБо.envуГХуВбуВдуГлуВТф╜ЬцИР
print_info "уГРуГГуВпуВиуГ│уГЙчФиуБочТ░хвГшинхоЪуГХуВбуВдуГлуВТф╜ЬцИРф╕н..."
cat > backend/.env << EOF
# ========================================
# уГРуГГуВпуВиуГ│уГЙчТ░хвГшинхоЪ
# ========================================
# уБУуБоуГХуВбуВдуГлуБпшЗкхЛХчФЯцИРуБХуВМуБжуБДуБ╛уБЩуАВч╖ищЫЖуБЧуБкуБДуБзуБПуБауБХуБДуАВ
# хдЙцЫ┤уБЩуВЛха┤хРИуБпуАБуГЧуГнуВ╕уВзуВпуГИуГлуГ╝уГИуБо .env уГХуВбуВдуГлуВТч╖ищЫЖуБЧуБжуБПуБауБХуБДуАВ

# уВ╡уГ╝уГРуГ╝шинхоЪ
PORT=${PORT:-4000}
NODE_ENV=${NODE_ENV:-development}

# FirebaseшинхоЪ
FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}

# OpenAIшинхоЪ
OPENAI_API_KEY=${OPENAI_API_KEY}
OPENAI_MODEL=${OPENAI_MODEL:-gpt-4}

# CORSшинхоЪ
CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}

# JWTшинхоЪ
JWT_SECRET=${JWT_SECRET}
JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}

# щЦЛчЩ║чТ░хвГшинхоЪ
DEBUG=${DEBUG:-true}
LOG_LEVEL=${LOG_LEVEL:-debug}
EOF

print_success "backend/.env уВТф╜ЬцИРуБЧуБ╛уБЧуБЯ"

# уГвуГРуВдуГлуВвуГЧуГкчФиуБо.envуГХуВбуВдуГлуВТф╜ЬцИР
print_info "уГвуГРуВдуГлуВвуГЧуГкчФиуБочТ░хвГшинхоЪуГХуВбуВдуГлуВТф╜ЬцИРф╕н..."
cat > apps/mobile/.env << EOF
# ========================================
# уГвуГРуВдуГлуВвуГЧуГкчТ░хвГшинхоЪ
# ========================================
# уБУуБоуГХуВбуВдуГлуБпшЗкхЛХчФЯцИРуБХуВМуБжуБДуБ╛уБЩуАВч╖ищЫЖуБЧуБкуБДуБзуБПуБауБХуБДуАВ
# хдЙцЫ┤уБЩуВЛха┤хРИуБпуАБуГЧуГнуВ╕уВзуВпуГИуГлуГ╝уГИуБо .env уГХуВбуВдуГлуВТч╖ищЫЖуБЧуБжуБПуБауБХуБДуАВ

# OpenAIшинхоЪ
OPENAI_API_KEY=${OPENAI_API_KEY}
OPENAI_MODEL=${OPENAI_MODEL:-gpt-4}

# щЦЛчЩ║чТ░хвГшинхоЪ
DEBUG=${DEBUG:-true}
LOG_LEVEL=${LOG_LEVEL:-debug}
EOF

print_success "apps/mobile/.env уВТф╜ЬцИРуБЧуБ╛уБЧуБЯ"

# шинхоЪуГХуВбуВдуГлуБоцийщЩРуВТшинхоЪ
chmod 600 backend/.env 2>/dev/null || true

echo
print_success "чТ░хвГшинхоЪуВ╗уГГуГИуВвуГГуГЧуБМхоМф║ЖуБЧуБ╛уБЧуБЯя╝Б"
echo
print_info "шинхоЪуГХуВбуВдуГлуБМцнгх╕╕уБлчФЯцИРуБХуВМуБ╛уБЧуБЯя╝Ъ"
echo "  - backend/.env"
echo "  - apps/web/.env.local"
echo "  - apps/mobile/lib/config/app_config.dart"
echo
print_info "шинхоЪуВТхдЙцЫ┤уБЩуВЛха┤хРИуБпуАБуГЧуГнуВ╕уВзуВпуГИуГлуГ╝уГИуБо .env уГХуВбуВдуГлуВТч╖ищЫЖуБЧуБжуБЛуВЙуАБ"
echo "уБУуБоуВ╣уВпуГкуГЧуГИуВТхЖНхоЯшбМуБЧуБжуБПуБауБХуБДуАВ"
echo
print_warning "ц│ицДПя╝Ъ.env уГХуВбуВдуГлуБп .gitignore уБлхРлуБ╛уВМуБжуБДуВЛуБЯуВБуАБ"
echo "    уГРуГ╝уВ╕уГзуГ│чобчРЖуБХуВМуБ╛уБЫуВУуАВцйЯхпЖцГЕха▒уВТхоЙхЕиуБлчобчРЖуБЧуБжуБПуБауБХуБДуАВ" 